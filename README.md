# Kindle to PDF Converter

Kindle本を自動的にスクリーンショットしてPDFファイルに変換するPythonアプリケーションです。

## ⚠️ 重要な注意事項

- **このツールは個人的なバックアップ目的のみに使用してください**
- Amazonの利用規約を必ず確認してください
- DRM保護されたコンテンツの扱いには十分注意してください
- 著作権法を遵守してください
- 商用利用や再配布は禁止されています

## 🎯 機能

- ✅ Kindle Cloud Readerの自動操作
- ✅ ページごとの自動スクリーンショット
- ✅ 複数の画像を1つのPDFファイルに統合
- ✅ **3つのキャプチャモード**（手動入力/自動検出/自動完了）
- ✅ **最終ページ自動検出**（ページ数不明でも完全自動化！）
- ✅ **総ページ数の自動検出**（ページ番号表示から）
- ✅ **GUIで簡単に領域選択**
- ✅ **画像からPDF作成ツール**（キャプチャとPDF作成を分離可能）
- ✅ カスタマイズ可能な設定（ページ数、遅延時間など）
- ✅ 自動的なChromeDriverのセットアップ
- ✅ ワンクリック実行用バッチファイル付き

## 📋 必要な環境

- Windows 10/11
- Python 3.8以上
- Google Chrome（最新版推奨）
- インターネット接続

## 🚀 クイックスタート（初めての方向け）

### 1. 必要なパッケージのインストール

プロジェクトフォルダで以下のコマンドを実行：

```bash
pip install -r requirements.txt
```

### 2. スクリーンショット領域の設定（オプション）

**全画面キャプチャでOKな場合はスキップ**してください。

特定の領域だけをキャプチャしたい場合：

```
set_region.bat をダブルクリック
```

1. Kindle Cloud Readerで本のページを開く
2. 領域設定ツールでEnterキーを押す
3. マウスでドラッグして領域を選択
4. 自動的に`config.json`が更新されます

### 3. PDF変換の実行

```
00_run_kindle_to_pdf.bat をダブルクリック
```

1. ブラウザが起動してKindle Cloud Readerが開きます
2. ログインして本を開きます
3. 本の**最初のページ（ページ1）**に移動
4. （オプション）F11キーで全画面モード
5. **ページめくり方向を確認**（左矢印または右矢印キーで次ページに進むかテスト）
6. `config.json`の`page_turn_direction`を設定（"left"または"right"）
7. ターミナルでEnterキーを押す
8. **キャプチャモードを選択**：
   - **モード1（手動入力）**: ページ数を入力して実行
   - **モード2（自動検出）**: ページ番号表示から自動検出
   - **モード3（自動完了）**: 最終ページまで完全自動！
9. 自動キャプチャ開始！
10. 💡 **重要**: キャプチャ中に **Ctrl+X** を押すといつでも終了できます

## 📁 ファイル構成

```
0104_Kindle2PDF/
├── kindle_to_pdf.py               # メインアプリケーション
├── make_pdf.py                    # 画像からPDF作成ツール
├── set_screenshot_region.py       # 領域選択ツール
├── test_page_detection.py         # ページ数検出テスト
├── test_page_navigation.py        # ページ送りテスト
├── test_last_page_detection.py    # 最終ページ検出テスト
├── config.json                    # 設定ファイル
├── config.template.json           # 設定ファイルのテンプレート
├── requirements.txt               # 必要なパッケージ
├── 00_run_kindle_to_pdf.bat       # メインアプリ実行用バッチ
├── 04_make_pdf.bat                # PDF作成用バッチ
├── set_region.bat                 # 領域設定用バッチ
├── test_page_detection.bat        # ページ数検出テスト用
├── test_page_navigation.bat       # ページ送りテスト用
├── test_last_page_detection.bat   # 最終ページ検出テスト用
├── README.md                      # このファイル
└── data/                          # スクリーンショット保存先
```

## ⚙️ 詳細な使い方

### 設定ファイル（config.json）の編集

必要に応じて`config.json`を編集してください：

```json
{
  "total_pages": null,
  "output_dir": "data",
  "pdf_filename": null,
  "page_delay": 2.0,
  "screenshot_region": null,
  "fullscreen": true,
  "delete_screenshots": false,
  "page_turn_direction": "left"
}
```

#### 設定項目の説明

| 項目 | 説明 | デフォルト | 推奨値 |
|------|------|------------|--------|
| `total_pages` | キャプチャするページの総数（`null`の場合は自動検出） | null | null（自動）または数値 |
| `output_dir` | スクリーンショット保存先 | "data" | "data" |
| `pdf_filename` | 出力PDFファイル名 | null | null（自動生成） |
| `page_delay` | ページ送り後の待機時間（秒） | 2.0 | 1.5～3.0 |
| `screenshot_region` | スクリーンショット領域 `[x, y, width, height]` | null | null（全画面） |
| `fullscreen` | ブラウザを最大化するか | true | true |
| `delete_screenshots` | PDF作成後に画像を削除 | false | false |
| `page_turn_direction` | ページめくり方向（"left"または"right"） | "left" | "left"または"right" |

### 🎮 キャプチャモードの選択

プログラム起動時に3つのモードから選択できます：

#### モード1: 手動入力モード
- **総ページ数を手動で入力**
- 最も確実で高速な方法
- ページ数が分かっている場合に推奨

#### モード2: 自動検出モード（ページ番号表示から）
- **画面のページ番号表示（例: "5 / 196"）から自動検出**
- Kindle Cloud Readerにページ番号が表示されている場合に有効
- 検出失敗時は手動入力または自動完了モードに切り替え

#### モード3: 自動完了モード（最終ページまで自動）⭐推奨
- **最終ページに到達するまで完全自動でキャプチャ**
- ページ数が不明でもOK
- ページ番号が飛び番号でもOK（Kindle本の仕様に対応）
- **Ctrl+X でいつでも手動終了可能**
- 4つの指標で最終ページを検出：
  - URLの変化
  - コンテンツハッシュ（最重要）
  - ページソース
  - ページ番号情報
- やや時間がかかる可能性あり（各ページで検出処理）

### ⌨️ キャプチャ中の操作

キャプチャ中は以下のキー操作が可能です：

#### Ctrl+X: キャプチャを手動終了
- キャプチャ中にいつでも **Ctrl+X** を押すと、その時点でキャプチャを終了
- 最終ページまで行ったと判断したら、すぐに終了できます
- キャプチャした画像は保持され、PDF作成に進みます

**使用例:**
```
💡 ヒント: キャプチャ中に Ctrl+X を押すといつでも終了できます

ページ 95/196 をキャプチャ中...
  現在のURL: https://read.amazon.co.jp/...
  ✓ スクリーンショット保存: data\page_0095.png

[ユーザーが Ctrl+X を押す]

======================================================================
⚠️  Ctrl+X が押されました！
キャプチャを終了します...
======================================================================

✓ ユーザーによって手動終了されました（95ページまでキャプチャ完了）
```

**選択画面の例:**
```
======================================================================
キャプチャモードを選択してください
======================================================================

1. 手動入力モード
   - 総ページ数を手動で入力します
   - 最も確実で高速な方法

2. 自動検出モード（ページ番号表示から）
   - 画面に表示されているページ番号（例: 5/196）から検出
   - ページ番号が表示されている場合に有効

3. 自動完了モード（最終ページまで自動）
   - 最終ページに到達するまで自動的にキャプチャ
   - ページ数不明でも完全自動化
   - やや時間がかかる可能性あり

======================================================================
モードを選択してください (1/2/3): 
```

### 📊 テストツール

各機能を個別にテストできるツールを用意しています：

#### ページ数検出テスト
```bash
test_page_detection.bat
```
画面からページ番号を検出できるかテスト

#### 最終ページ検出テスト
```bash
test_last_page_detection.bat
```
最終ページの自動検出機能をテスト（本の最後の方で実行推奨）

#### ページ送りテスト
```bash
test_page_navigation.bat
```
ページめくり動作をテスト

### スクリーンショット領域の設定方法

#### 方法1: GUIツールで設定（推奨）

1. **`set_region.bat`をダブルクリック**
2. モード1を選択
3. Kindle Cloud Readerで本のページを開く
4. Enterキーを押す
5. 画面が半透明になるので、マウスでドラッグして領域を選択
6. 自動的に`config.json`が更新されます

#### 方法2: 手動で座標を設定

1. **`set_region.bat`をダブルクリック**
2. モード2を選択（マウス位置確認モード）
3. マウスを動かして座標を確認
4. 左上と右下の座標をメモ
5. `config.json`を編集：
   ```json
   "screenshot_region": [x, y, width, height]
   ```

**例**: 位置(200, 100)から幅1520px、高さ880pxの領域
```json
"screenshot_region": [200, 100, 1520, 880]
```

### 画像からPDF作成（分離実行）

スクリーンショットとPDF作成を分離して実行できます：

```bash
04_make_pdf.bat
```

**使い方:**
1. `data` フォルダに画像ファイルが保存されていることを確認
2. `04_make_pdf.bat` を実行
3. 確認メッセージで `y` を入力
4. PDFが作成されます

**メリット:**
- スクリーンショット撮影とPDF作成を別々に実行可能
- 画像を確認してからPDF化できる
- PDF作成に失敗しても画像は残る

### コマンドラインでの実行

#### バッチファイルを使う場合（簡単）

```bash
# 領域設定
set_region.bat

# PDF変換実行（スクリーンショット + PDF作成）
00_run_kindle_to_pdf.bat

# 画像からPDF作成のみ
04_make_pdf.bat
```

#### Pythonコマンドで実行する場合

```bash
# 仮想環境がある場合
.venv\Scripts\python.exe kindle_to_pdf.py

# 仮想環境がない場合
python kindle_to_pdf.py
```

## 🎨 使用例

### 例1: ページ数不明の本を完全自動でキャプチャ（推奨）

**config.json**:
```json
{
  "total_pages": null,
  "output_dir": "data",
  "screenshot_region": null,
  "fullscreen": true,
  "page_turn_direction": "left"
}
```

**実行:**
1. `00_run_kindle_to_pdf.bat` を実行
2. 本を開いて最初のページに移動
3. モード選択で「3」（自動完了モード）を選択
4. あとは自動で最後まで実行！

### 例2: 100ページの本を手動入力で高速キャプチャ

**config.json**:
```json
{
  "total_pages": null,
  "output_dir": "data",
  "screenshot_region": null,
  "fullscreen": true
}
```

**実行:**
1. `00_run_kindle_to_pdf.bat` を実行
2. モード選択で「1」（手動入力）を選択
3. ページ数「100」を入力
4. 高速でキャプチャ完了

### 例3: 画像とPDF作成を分離

**手順:**
1. `00_run_kindle_to_pdf.bat` でスクリーンショットのみ撮影
   - `config.json` で `"delete_screenshots": false` を設定
2. `data` フォルダの画像を確認
3. `04_make_pdf.bat` でPDF作成

**メリット:**
- 問題があれば画像だけ残して再実行可能
- 複数の本の画像を撮影してから一括PDF化

### 例4: 部分領域キャプチャ（50ページ）

1. `set_region.bat`で領域を選択
2. `config.json`を確認：
   ```json
   {
     "total_pages": null,
     "screenshot_region": [300, 150, 1320, 800]
   }
   ```
3. `00_run_kindle_to_pdf.bat`を実行してモード選択

### 例5: ページ読み込みが遅い場合

**config.json**:
```json
{
  "page_delay": 3.0
}
```

ネットワークが遅い場合は`page_delay`を増やしてください。

### 例6: ページめくり方向が逆の本の場合

一部の本は右矢印キーで次のページに進みます：

**config.json**:
```json
{
  "page_turn_direction": "right"
}
```

本を開いたら、左右の矢印キーを試して正しい方向を確認してください。

## 📤 出力ファイル

### スクリーンショット画像

- 保存先: `data/`フォルダ
- ファイル名: `page_0001.png`, `page_0002.png`, ...
- 形式: PNG

### PDF ファイル

- 保存先: プロジェクトルート
- ファイル名: `kindle_book_20251129_143055.pdf`（タイムスタンプ付き）
- または: `config.json`で指定した名前

## 🔧 トラブルシューティング

### キャプチャが止まらない / ページ数が多すぎる

**解決方法**:
- **Ctrl+X** を押してキャプチャを手動終了
- 最終ページに到達したと判断したら、いつでも終了できます
- キャプチャした画像は保持され、PDF作成に進みます

### ブラウザが起動しない

**原因と対処法**:
- Google Chromeが最新版であることを確認
- `webdriver-manager`が正常にインストールされているか確認
- セキュリティソフトがブラウザ起動をブロックしていないか確認

```bash
# ChromeDriverを再インストール
pip install --upgrade webdriver-manager
```

### pynputのインストールエラー

**解決方法**:
```bash
pip install --upgrade pynput
```

または、requirements.txtから再インストール:
```bash
pip install -r requirements.txt
```

### スクリーンショットが正しくキャプチャされない

**原因と対処法**:
- **領域設定が間違っている**: `set_region.bat`で再設定
- **ページ読み込みが遅い**: `page_delay`を2.0→3.0に増やす
- **ブラウザのズーム倍率**: ブラウザのズームを100%に設定
- **モニター解像度**: 高DPI環境では座標がずれる可能性あり

### ページ送りがうまくいかない

**原因と対処法**:
- **ページめくり方向が逆**: `page_turn_direction`を"left"→"right"（または逆）に変更
- Kindle Cloud Readerが正しくフォーカスされているか確認
- `page_delay`を2秒以上に設定してみる
- ブラウザの他のタブやウィンドウを閉じる
- キーボードショートカットが競合していないか確認
- 本を開いた状態で手動で左右矢印キーを試して、どちらで次ページに進むか確認

### PDFの作成に失敗する

**原因と対処法**:
- `img2pdf`が正常にインストールされているか確認
- ディスク容量が十分にあるか確認（100ページで約100-500MB必要）
- ファイル名に使用できない文字が含まれていないか確認
- アンチウイルスソフトがブロックしていないか確認

```bash
# img2pdfを再インストール
pip install --upgrade img2pdf
```

### プログラムが途中で止まる

**原因と対処法**:
- ネットワーク接続を確認
- Kindle Cloud Readerがログアウトされていないか確認
- `page_delay`を増やして安定性を向上
- スリープモードに入らないよう電源設定を確認

## 💡 Tips & ベストプラクティス

### ✅ おすすめの設定

```json
{
  "total_pages": 100,
  "output_dir": "data",
  "pdf_filename": null,
  "page_delay": 2.0,
  "screenshot_region": null,
  "fullscreen": true,
  "delete_screenshots": false,
  "page_turn_direction": "left"
}
```

**注意**: `page_turn_direction`は本によって異なります。本を開いたら左右矢印キーを試して、正しい方向を確認してください。

### ✅ 実行前のチェックリスト

- [ ] Chromeブラウザが最新版
- [ ] ネットワーク接続が安定している
- [ ] 十分なディスク容量がある（ページ数 × 5MB程度）
- [ ] `config.json`のページ数が正しい
- [ ] `config.json`のページめくり方向（"left"/"right"）を確認済み
- [ ] 他の作業を中断して専念できる時間がある

### ✅ 品質を向上させるコツ

1. **全画面モード**: F11キーでブラウザUI を完全に非表示
2. **ズーム100%**: ブラウザのズームを100%に設定
3. **安定したネット**: 有線LAN推奨
4. **遅延時間を長めに**: 初回は`page_delay: 3.0`で試す
5. **夜間実行**: ネットワークが空いている時間帯

### ✅ 大量ページの本を処理する場合

100ページ以上の本の場合：

1. **分割実行**: 50ページずつ分けて実行
2. **休憩を入れる**: プログラムに休憩時間を追加（カスタマイズ）
3. **ディスク容量**: 事前に十分な空き容量を確保

## ❓ よくある質問（FAQ）

### Q1: すべてのKindle本で動作しますか？

**A**: Kindle Cloud Readerで開ける本であれば基本的に動作します。ただし、以下の制限があります：
- 固定レイアウトの本は調整が必要な場合あり
- 雑誌やマンガは特別な設定が必要な場合あり
- DRM保護が厳しい本は開けない可能性あり

### Q2: モバイル版のKindleアプリでも使えますか？

**A**: いいえ、現在はPC版のKindle Cloud Reader専用です。モバイル版には対応していません。

### Q3: ページ数が事前にわからない場合は？

**A**: 以下の方法で確認できます：
1. Kindle Cloud Readerで本を開く
2. 最後のページまで移動
3. ページ番号を確認
4. `config.json`の`total_pages`に設定

### Q4: 自動的にページ数を検出できませんか？

**A**: 現在のバージョンでは手動設定が必要です。将来のバージョンでOCR機能を追加する予定です。

### Q5: 画像の品質を上げられますか？

**A**: はい、以下の方法があります：
1. 高解像度モニターを使用
2. ブラウザのズームを調整（推奨：100%）
3. Kindle Cloud Readerの表示設定を調整
4. `screenshot_region`で本文のみをキャプチャ

### Q6: PDFのファイルサイズが大きすぎます

**A**: 以下の方法で削減できます：
1. `delete_screenshots: true`に設定（画像を削除）
2. 画像を圧縮するツールを別途使用
3. `screenshot_region`で必要な部分のみキャプチャ

### Q7: 商用利用は可能ですか？

**A**: いいえ、このツールは**個人的なバックアップ目的のみ**に使用してください。商用利用や再配布は禁止されています。Amazonの利用規約も確認してください。

### Q8: Macでも使えますか？

**A**: 現在はWindows専用ですが、Pythonコードは基本的にクロスプラットフォームです。`.bat`ファイルを`.sh`に変更し、パスを調整すれば動作する可能性があります。

## 📚 関連リソース

- [Kindle Cloud Reader](https://read.amazon.com)
- [Selenium Documentation](https://selenium-python.readthedocs.io/)
- [PyAutoGUI Documentation](https://pyautogui.readthedocs.io/)

## 📝 ライセンス

このプロジェクトは個人利用目的で作成されています。商用利用は禁止されています。

## ⚖️ 免責事項

このツールの使用により生じたいかなる損害についても、開発者は責任を負いません。利用者の自己責任でご使用ください。

- このツールはスクリーンショットを利用した個人的なバックアップツールです
- Amazonの利用規約および著作権法を遵守してください
- DRM保護されたコンテンツの不正な配布や共有は違法です
- 本ツールを使用したことによるアカウント停止等の責任は負いかねます

---

**作成日**: 2025年11月29日  
**バージョン**: 1.0.0

質問や問題がある場合は、GitHubのIssueで報告してください。